# Dashboard Smart Mode Routing ‚úÖ

## T·ªïng Quan
Dashboard gi·ªù s·∫Ω d·∫´n user t·ªõi ƒë√∫ng mode (dictation ho·∫∑c shadowing) d·ª±a tr√™n progress c·ªßa user, thay v√¨ lu√¥n d·∫´n t·ªõi shadowing.

## Problem Before

### Old Behavior:
```javascript
onClick={() => router.push(`/shadowing/${lesson.id}`)}
```

**Issues:**
- ‚ùå Lu√¥n d·∫´n t·ªõi shadowing
- ‚ùå Ngay c·∫£ khi user ƒëang l√†m dictation
- ‚ùå User ph·∫£i t·ª± ch·ªçn l·∫°i mode
- ‚ùå Kh√¥ng ti·ªán l·ª£i

**Example:**
```
User l√†m B√†i 1 Dictation (30% progress)
Click v√†o card trong dashboard
‚Üí D·∫´n t·ªõi Shadowing mode (sai!)
‚Üí User ph·∫£i quay l·∫°i v√† ch·ªçn Dictation
```

## Solution Implemented

### New Behavior:
```javascript
const primaryMode = getPrimaryMode(lesson.id);
onClick={() => router.push(`/${primaryMode}/${lesson.id}`)}
```

**Benefits:**
- ‚úÖ D·∫´n t·ªõi ƒë√∫ng mode user ƒëang l√†m
- ‚úÖ T·ª± ƒë·ªông detect mode t·ª´ progress
- ‚úÖ Ti·ªán l·ª£i, kh√¥ng c·∫ßn ch·ªçn l·∫°i
- ‚úÖ Smart routing

**Example:**
```
User l√†m B√†i 1 Dictation (30% progress)
Click v√†o card trong dashboard
‚Üí D·∫´n t·ªõi Dictation mode ‚úÖ
‚Üí User ti·∫øp t·ª•c t·ª´ ch·ªó ƒë√£ d·ª´ng
```

## Implementation

### 1. Get Primary Mode Function

```javascript
const getPrimaryMode = (lessonId) => {
  const lessonProgress = progress.filter(p => p.lessonId === lessonId);
  if (lessonProgress.length === 0) return 'shadowing'; // default
  
  // Sort by completion percent (highest first), then by updatedAt (most recent first)
  const sortedProgress = lessonProgress.sort((a, b) => {
    if (b.completionPercent !== a.completionPercent) {
      return (b.completionPercent || 0) - (a.completionPercent || 0);
    }
    return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
  });
  
  return sortedProgress[0].mode; // Return the mode with highest progress
};
```

### 2. Priority Logic

#### Priority 1: Highest Completion Percent
```javascript
if (b.completionPercent !== a.completionPercent) {
  return (b.completionPercent || 0) - (a.completionPercent || 0);
}
```

**Example:**
```
Progress data:
- Dictation: 60%
- Shadowing: 30%

Primary mode: Dictation (higher %)
```

#### Priority 2: Most Recent (if same %)
```javascript
return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
```

**Example:**
```
Progress data:
- Dictation: 30% (updated 2 days ago)
- Shadowing: 30% (updated today)

Primary mode: Shadowing (more recent)
```

#### Priority 3: Default to Shadowing
```javascript
if (lessonProgress.length === 0) return 'shadowing';
```

**When:** No progress data found (shouldn't happen if filter works correctly)

### 3. Mode Badge Display

```javascript
<div style={{ 
  display: 'inline-block',
  padding: '4px 12px',
  borderRadius: '12px',
  fontSize: '11px',
  fontWeight: '700',
  marginBottom: '12px',
  background: primaryMode === 'dictation' 
    ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
    : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
  color: 'white',
  textTransform: 'uppercase',
  letterSpacing: '0.5px'
}}>
  {primaryMode === 'dictation' ? '‚úçÔ∏è Ch√≠nh T·∫£' : 'üé§ Shadowing'}
</div>
```

**Visual:**
```
Dictation Mode:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úçÔ∏è CH√çNH T·∫¢ ‚îÇ  ‚Üê Purple gradient
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Shadowing Mode:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üé§ SHADOWING‚îÇ  ‚Üê Pink gradient
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## User Experience Flow

### Scenario 1: Pure Dictation User
```
User l√†m B√†i 1:
- Dictation: 45%
- Shadowing: 0% (never tried)

Dashboard card shows:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìñ Lektion 1: Patient Erde‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ ‚îÇ ‚úçÔ∏è CH√çNH T·∫¢ ‚îÇ            ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ Progress: 45%              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Click card ‚Üí /dictation/bai_1 ‚úÖ
```

### Scenario 2: Pure Shadowing User
```
User l√†m B√†i 2:
- Dictation: 0%
- Shadowing: 60%

Dashboard card shows:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìñ Lektion 2: Das Klima   ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ ‚îÇ üé§ SHADOWING‚îÇ            ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ Progress: 60%              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Click card ‚Üí /shadowing/bai_2 ‚úÖ
```

### Scenario 3: Mixed User (Both Modes)
```
User l√†m B√†i 3:
- Dictation: 30%
- Shadowing: 70%  ‚Üê Higher!

Dashboard card shows:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìñ Lektion 3: Die Energie ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ ‚îÇ üé§ SHADOWING‚îÇ            ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ Progress: 70%              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Click card ‚Üí /shadowing/bai_3 ‚úÖ
Primary mode: Shadowing (higher progress)
```

### Scenario 4: Same Progress Different Modes
```
User l√†m B√†i 4:
- Dictation: 40% (updated yesterday)
- Shadowing: 40% (updated today)  ‚Üê More recent!

Dashboard card shows:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìñ Lektion 4: Der Sport   ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ ‚îÇ üé§ SHADOWING‚îÇ            ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ Progress: 40%              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Click card ‚Üí /shadowing/bai_4 ‚úÖ
Primary mode: Shadowing (more recent)
```

## Integration with Existing Features

### 1. Progress Calculation (Unchanged)
```javascript
const calculateProgress = (lessonId) => {
  const lessonProgress = progress.filter(p => p.lessonId === lessonId);
  if (lessonProgress.length === 0) return 0;
  
  // Get max completion percent across all modes
  const maxProgress = Math.max(...lessonProgress.map(p => p.completionPercent || 0));
  
  return Math.min(100, maxProgress);
};
```

**Still shows MAX progress** across all modes (correct behavior)

### 2. Lesson Filtering (Unchanged)
```javascript
// Only show lessons with progress
const lessonIdsWithProgress = [...new Set(progressData.map(p => p.lessonId))];
const lessonsWithProgress = allLessons.filter(lesson => 
  lessonIdsWithProgress.includes(lesson.id)
);
```

**Still filters** to show only started lessons

### 3. Status Badges (Unchanged)
```javascript
{progressPercent === 100 && (
  <div className={`${styles.statusBadge} ${styles.completed}`}>
    <span>‚úÖ</span>
    <span>Ho√†n th√†nh</span>
  </div>
)}
```

**Still shows** completion badge at 100%

## Color Coding

### Mode Badge Colors:

#### Dictation (Ch√≠nh T·∫£):
```css
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
```
- Purple gradient
- Matches input border colors
- Consistent branding

#### Shadowing:
```css
background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
```
- Pink-red gradient
- Different from dictation
- Easy to distinguish

## Edge Cases

### Edge Case 1: No Progress (Default)
```javascript
if (lessonProgress.length === 0) return 'shadowing';
```
**Shouldn't happen** (lesson already filtered by progress), but safe default.

### Edge Case 2: Both Modes 0%
```
- Dictation: 0% (updated today)
- Shadowing: 0% (updated yesterday)

Primary mode: Dictation (more recent)
```

### Edge Case 3: Null/Undefined Values
```javascript
(b.completionPercent || 0) - (a.completionPercent || 0)
new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0)
```
**Handles nulls gracefully** with fallback to 0

### Edge Case 4: Invalid Mode
```javascript
// If progress.mode is invalid (e.g., "quiz")
// onClick: router.push(`/quiz/${lesson.id}`)
// Will 404, but doesn't crash
```

## Testing Scenarios

### Test 1: Dictation Only
```
1. Login
2. Do B√†i 1 Dictation (type 3 words)
3. Go to dashboard
4. See badge: "‚úçÔ∏è CH√çNH T·∫¢"
5. Click card
6. Should go to: /dictation/bai_1 ‚úÖ
```

### Test 2: Shadowing Only
```
1. Login
2. Do B√†i 1 Shadowing (play audio)
3. Go to dashboard
4. See badge: "üé§ SHADOWING"
5. Click card
6. Should go to: /shadowing/bai_1 ‚úÖ
```

### Test 3: Both Modes (Dictation Higher)
```
1. Login
2. Do B√†i 1 Dictation (50%)
3. Do B√†i 1 Shadowing (20%)
4. Go to dashboard
5. See badge: "‚úçÔ∏è CH√çNH T·∫¢" (higher %)
6. Progress: 50%
7. Click card
8. Should go to: /dictation/bai_1 ‚úÖ
```

### Test 4: Both Modes (Same %, Recent Shadowing)
```
1. Login
2. Do B√†i 1 Dictation (40%) yesterday
3. Do B√†i 1 Shadowing (40%) today
4. Go to dashboard
5. See badge: "üé§ SHADOWING" (more recent)
6. Progress: 40%
7. Click card
8. Should go to: /shadowing/bai_1 ‚úÖ
```

## Files Modified

### 1. `/pages/dashboard.js`

**New Function:**
```javascript
const getPrimaryMode = (lessonId) => { ... }
```
- 15 lines
- Sorts progress by completion % and date
- Returns mode string

**Updated Rendering:**
```javascript
const primaryMode = getPrimaryMode(lesson.id);
```
- Get mode before rendering

```javascript
onClick={() => router.push(`/${primaryMode}/${lesson.id}`)}
```
- Dynamic route based on mode

**New Badge:**
```jsx
<div style={{ ... }}>
  {primaryMode === 'dictation' ? '‚úçÔ∏è Ch√≠nh T·∫£' : 'üé§ Shadowing'}
</div>
```
- Visual indicator of mode
- Gradient background
- Icon + text

**Total Changes:** ~30 lines

## Summary

‚úÖ **Problem:** Dashboard lu√¥n d·∫´n t·ªõi shadowing

‚úÖ **Solution:** Smart routing d·ª±a tr√™n progress

‚úÖ **Logic:**
1. Get all progress for lesson
2. Sort by: completion % ‚Üí date
3. Take highest/most recent mode
4. Route to that mode

‚úÖ **Visual:** Badge hi·ªÉn th·ªã mode

‚úÖ **Colors:**
- Dictation: Purple gradient
- Shadowing: Pink gradient

‚úÖ **Edge Cases:** All handled

‚úÖ **Testing:** Ready to test

**Status: Production Ready! üöÄ**

**Server:** http://localhost:3010

**Test Now:**
1. Login
2. L√†m B√†i 1 Dictation (g√µ v√†i t·ª´)
3. V√†o Dashboard
4. Th·∫•y badge "‚úçÔ∏è CH√çNH T·∫¢"
5. Click v√†o card
6. D·∫´n t·ªõi /dictation/bai_1 ‚úÖ
7. Perfect! üéØ
